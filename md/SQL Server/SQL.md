### 数据库结构设计

几条建议

- 尽可能的添加数据完整约束，例如非空、默认值、check、唯一约束和外键约束等。完整的约束将有助数据库关系引擎分析执行计划   

- 尽可能小的字段类型，特别是大表。
- 表结构应该考虑业务需求带来的操作频率
- 不要对包含索引的字段使用任何计算 包括函数，这会导致索引无法进行数据检索
- 小表驱动大表，使其尽量使用Nested Loop（表关联操作的一种物理操作方式，它使用foreach的方式以较小的数据集为驱动，内嵌foreach较大的表进行对比，效率较高）。
- 尽量使用简单的sql来完成业务。简单的定义为 关联2~4个表，2~3个过了条件

各个约束的性能影响

- 默认值只有在新增时候才会调用，几乎没有
- check尽量是用较为简单的表达式
- 唯一约束会创建唯一索引，利用索引树结构来检索，数据更新的时候一定的开销，很小。每一个表至少应该有一个唯一约束
- 外键是为了保证主表和子表数据的完整性。主表关联一定是主键或者唯一键，校验速度很快。删除的时候外键约束回去扫描整个子表，这会有较大的开销。所以在添加外键的时候，子表关联字段最好创建索引。对于数据完整性没有要求的不要创建外键

适当冗余数据。避免过多表关联的常用手段。带来的问题是维护成本的提高。如果每天访问频率远远大于修改的频率完全可以考虑使用。



```sql
-- 查询每一个数据库的缓存大小
select count(*) * 8 / 1024 AS 'Size(MB)', db_name(database_id), database_id
from sys.dm_os_buffer_descriptors
group by database_id

-- 查询当前数据库中的脏页
select count(page_id) AS 'Dirty Pages(KB)', db_name(database_id)
from sys.dm_os_buffer_descriptors
group by database_id
```

